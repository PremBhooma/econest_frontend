import { useEffect, useState } from "react";
import { Link } from 'react-router-dom';
import Customerapi from "../../api/Customerapi";
import Errorpanel from "../../shared/Errorpanel";
import noImageStaticImage from "../../../../public/assets/imageplaceholder.png";

function Flatinfo({ customerUuid }) {
    const [errorMessage, setErrorMessage] = useState("");
    const [isLoadingEffect, setIsLoadingEffect] = useState(false);

    const [customerFlatsData, setCustomerFlatsData] = useState({});

    async function getCustomerFlatsData(customerUuid) {
        if (customerUuid === null) {
            setErrorMessage({
                message: "Customer ID is missing",
                server_res: null,
            });
            setIsLoadingEffect(false);
            return false;
        }

        setIsLoadingEffect(true);
        await Customerapi.get("get-customers-flats", {
            params: {
                customer_uuid: customerUuid,
            },
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then((response) => {
                const data = response?.data;
                if (data.status === "error") {
                    const finalresponse = {
                        message: data.message,
                        server_res: data,
                    };
                    setErrorMessage(finalresponse);
                    setIsLoadingEffect(false);
                    return false;
                }
                if (data !== null) {
                    setCustomerFlatsData(data?.data || {});
                }
                setIsLoadingEffect(false);
                return false;
            })
            .catch((error) => {
                console.log("Fetch customer error:", error);
                let finalresponse;
                if (error.response !== undefined) {
                    finalresponse = {
                        message: error.message,
                        server_res: error.response.data,
                    };
                } else {
                    finalresponse = {
                        message: error.message,
                        server_res: null,
                    };
                }
                setErrorMessage(finalresponse);
                setIsLoadingEffect(false);
                return false;
            });
    }

    useEffect(() => {
        setIsLoadingEffect(true);
        if (customerUuid) getCustomerFlatsData(customerUuid);
    }, [customerUuid]);

    const formatPrice = (price) => {
        return new Intl.NumberFormat("en-IN", {
            style: "currency",
            currency: "INR",
        })
            .format(price)
            .replace(".00", "");
    };

    const Info = ({ label, value, badge }) => (
        <div>
            <p className="text-xs text-gray-500">{label}</p>
            {badge ? (
                <span
                    className={`text-xs font-medium py-0.5 px-2 rounded ${value === "Sold"
                        ? "bg-green-100 text-green-600"
                        : "bg-red-100 text-red-600"
                        }`}
                >
                    {value || "-"}
                </span>
            ) : (
                <p className="text-sm font-medium text-gray-900 break-all">{value || "-"}</p>
            )}
        </div>
    );

    const InfoBig = ({ label, value }) => (
        <div>
            <p className="text-xs text-gray-500">{label}</p>
            <p className="text-lg font-semibold text-gray-900">{value || "-"}</p>
        </div>
    );

    return (
        <>
            <div className="flex flex-col gap-4">
                {customerFlatsData?.length > 0 ? (
                    customerFlatsData.map((ele, index) => {
                        const flats = ele?.flat_details;
                        return (
                            <div className="flex flex-col gap-3 w-full border border-gray-200 rounded-lg p-3 shadow-sm bg-white">

                                {/* Header */}
                                <div className="flex justify-between items-center">
                                    <Link to={`/flats/view-flat/${flats?.uuid}`}>
                                        <h2 className="text-base font-semibold text-gray-800 hover:text-[#0083bf]">
                                            Flat No: {flats?.flat_no || "-"}
                                        </h2>
                                    </Link>
                                    <h2 className="text-sm font-medium text-gray-600">{flats?.block || "-"}</h2>
                                </div>

                                {/* Flat image + details */}
                                <div className="flex flex-col md:flex-row gap-4">
                                    <Link to={`/flats/view-flat/${flats?.uuid}`} className="md:w-1/4">
                                        <img
                                            crossOrigin="anonymous"
                                            src={flats?.flat_img_url || noImageStaticImage}
                                            alt="Flat"
                                            className="w-full h-[150px] object-cover rounded-md border border-[#ebecef]"
                                        />
                                    </Link>

                                    <div className="w-full md:w-3/4 grid grid-cols-2 md:grid-cols-5 gap-3 mt-3">
                                        <Info label="Floor No" value={flats?.floor_no} />
                                        <Info label="Area (Sq.ft.)" value={flats?.square_feet} />
                                        <Info label="Type" value={flats?.type} />
                                        <Info label="Facing" value={flats?.facing} />
                                        <Info label="Bedrooms" value={flats?.bedrooms} />
                                        <Info label="Bathrooms" value={flats?.bathrooms} />
                                        <Info label="Balconies" value={flats?.balconies} />
                                        <Info label="Furnished" value={flats?.furnished_status} />
                                        <Info label="Parking" value={flats?.parking === true ? "Yes" : "No"} />
                                        {/* <Info
                                            label="Status"
                                            value={flats?.status}
                                            badge={true}
                                        /> */}
                                        <Info label="Corner" value={flats?.corner} />
                                    </div>
                                </div>

                                {/* Cost Details */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-3 border-t border-[#ebecef] pt-2">
                                    <Info label="Saleable Area (sq.ft)" value={ele?.saleable_area_sq_ft} />
                                    <Info label="Rate Per (sq.ft)" value={ele?.rate_per_sq_ft} />
                                    <Info label="Base Cost Unit" value={ele?.base_cost_unit} />
                                </div>

                                {/* Financial Summary */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
                                    <InfoBig label="Grand Total (₹)" value={formatPrice(ele?.grand_total)} />
                                    <InfoBig label="Payments Made (₹)" value={formatPrice(ele?.flat_details?.totalPayment)} />
                                    <InfoBig
                                        label="Balance Amount (₹)"
                                        value={formatPrice((ele?.grand_total || 0) - (ele?.flat_details?.totalPayment || 0))}
                                    />
                                </div>
                            </div>

                        );
                    })
                ) : (
                    <div className="text-center py-12 text-gray-500">No Flat Data Available</div>
                )}
            </div>

            {errorMessage &&
                <Errorpanel
                    errorMessages={errorMessage}
                    setErrorMessages={setErrorMessage}
                />
            }
        </>
    );
}

export default Flatinfo;
