import React, { useEffect, useState } from "react";
import Backup from "./backup/Backup";
import Blocks from "./blocks/Blocks.jsx";
import Project from "./project/Project.jsx";
import Amenities from "./amenities/Amenities.jsx";
import Groupowner from "./groupowner/Groupowner.jsx";
import Companyinfo from "./companyinfo/Companyinfo.jsx";
import BulkUploads from "./bulkuploads/Bulkuploads.jsx";
import AssignProject from "../shared/AssignProject.jsx";
import { Modal } from "@nayeshdaggula/tailify";
import { IconChartFunnel, IconDatabase, IconRestore, IconTemplate } from "@tabler/icons-react";
import { useProjectDetails } from "../zustand/useProjectDetails.jsx";
import { useEmployeeDetails } from "../zustand/useEmployeeDetails.jsx";
import Leadstageswrapper from "./leadstages/Leadstageswrapper.jsx";
import Templates from "./templates/Templates.jsx"
import Bankstab from "./banks/Bankstab.jsx";
import { BlocksIcon, Building2, GroupIcon, NotepadText, SquareChartGantt, Landmark } from "lucide-react";

function Settingswrapper() {

    const [activeTaskTab, setActiveTaskTab] = useState('company_info');
    const tabChange = (tab) => {
        setActiveTaskTab(tab);
    }

    const permissions = useEmployeeDetails((state) => state.permissions);

    const { projectData, hasFetched, fetchProjectData } = useProjectDetails();

    const [projectModel, setProjectModel] = useState(false);
    const openProjectModel = () => {
        setProjectModel(true);
    };
    const closeProjectModel = () => {
        setProjectModel(false);
    };

    useEffect(() => {
        fetchProjectData();
    }, []);

    useEffect(() => {
        if (hasFetched) {
            if (!projectData || (typeof projectData === 'object' && Object.keys(projectData).length === 0)) {
                openProjectModel();
            }
        }
    }, [hasFetched, projectData]);


    return (
        <>
            <div className='flex flex-col gap-4'>
                <div className="text-[24px] font-semibold">
                    Settings
                </div>


                <div className="flex justify-start items-center gap-2 overflow-x-auto pb-2 border-b border-neutral-200 w-full [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]">
                    {[
                        { id: 'company_info', label: 'Company Info', icon: Building2, permission: 'company_info_tab' },
                        { id: 'banks', label: 'Banks', icon: Landmark, permission: 'project_tab' },
                        { id: 'project', label: 'Project', icon: SquareChartGantt, permission: 'project_tab' },
                        { id: 'blocks', label: 'Blocks', icon: BlocksIcon, permission: 'blocks_tab' },
                        { id: 'amenities', label: 'Amenities Prices', icon: NotepadText, permission: 'amenities_tab' },
                        // { id: 'group_owner', label: 'Group/Owner', icon: GroupIcon, permission: 'group_owner_tab' },
                        // { id: 'bulk_uploads_tab', label: 'Global Upload', icon: IconDatabase, permission: 'global_tab' },
                        // { id: 'backup', label: 'Backup', icon: IconRestore, permission: 'backup_tab' },
                        { id: 'lead_stages', label: 'Lead Stages', icon: IconChartFunnel, permission: null }, // Assuming no specific permission or always visible
                        { id: 'templates', label: 'Templates', icon: IconTemplate, permission: null }
                    ].map((tab) => {
                        // Check permission if it exists
                        if (tab.permission && !permissions?.settings_page?.includes(tab.permission)) return null;

                        const Icon = tab.icon;
                        const isActive = activeTaskTab === tab.id;
                        return (
                            <button
                                key={tab.id}
                                onClick={() => tabChange(tab.id)}
                                className={`flex items-center gap-2 px-4 py-3 text-sm font-medium transition-all duration-200 whitespace-nowrap border-b-2 cursor-pointer
                                    ${isActive
                                        ? 'border-[#0083bf] text-[#0083bf]'
                                        : 'border-transparent text-neutral-500 hover:text-neutral-900 hover:bg-neutral-50 rounded-t-lg'
                                    }`}
                            >
                                <Icon size={18} stroke={1.5} />
                                <span>{tab.label}</span>
                            </button>
                        );
                    })}
                </div>
            </div>
            <div className="mt-3 full">
                {activeTaskTab === 'company_info' &&
                    <>
                        {permissions?.settings_page?.includes("company_info_tab") && (
                            <Companyinfo />
                        )}
                    </>
                }
                {activeTaskTab === 'banks' &&
                    <>
                        {permissions?.settings_page?.includes("project_tab") && (
                            <Bankstab />
                        )}
                    </>
                }
                {activeTaskTab === 'project' &&
                    <>
                        {permissions?.settings_page?.includes("project_tab") && (
                            <Project />
                        )}
                    </>
                }
                {activeTaskTab === 'blocks' &&
                    <>
                        {permissions?.settings_page?.includes("blocks_tab") && (
                            <Blocks />
                        )}
                    </>
                }
                {activeTaskTab === 'amenities' &&
                    <>
                        {permissions?.settings_page?.includes("amenities_tab") && (
                            <Amenities />
                        )}
                    </>
                }
                {activeTaskTab === 'group_owner' &&
                    <>
                        {permissions?.settings_page?.includes("group_owner_tab") && (
                            <Groupowner />
                        )}
                    </>
                }
                {activeTaskTab === 'backup' &&
                    <>
                        {permissions?.settings_page?.includes("backup_tab") && (
                            <Backup />
                        )}
                    </>
                }
                {activeTaskTab === 'bulk_uploads_tab' &&
                    <>
                        {permissions?.settings_page?.includes("global_tab") && (
                            <BulkUploads />
                        )}
                    </>
                }
                {activeTaskTab === 'lead_stages' &&
                    <>
                        <Leadstageswrapper />
                    </>
                }
                {activeTaskTab === 'templates' &&
                    <>
                        <Templates />
                    </>
                }
            </div>

            <Modal
                open={projectModel}
                onClose={closeProjectModel}
                size="lg"
                zIndex={9999}
                withCloseButton={false}
            >
                {projectModel === true && (
                    <AssignProject
                        closeProjectModel={closeProjectModel}
                    />
                )}
            </Modal>
        </>
    );
}

export default Settingswrapper;